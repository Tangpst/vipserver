<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的邀请名单</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            background-color: #FDF7FF;
            margin: 0;
            padding: 16px;
            font-family: 'Roboto', sans-serif;
            color: #1C1B1F;
        }

        /* 顶部总览卡片 */
        .hero-card {
            background: linear-gradient(135deg, #673AB7, #512DA8);
            border-radius: 16px;
            padding: 24px;
            color: white;
            box-shadow: 0 4px 8px rgba(103, 58, 183, 0.2);
            margin-bottom: 24px;
            position: relative;
            overflow: hidden;
        }
        .user-info {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
        }
        .avatar {
            width: 48px;
            height: 48px;
            background-color: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 12px;
            font-size: 20px;
        }
        .money-container {
            margin-bottom: 24px; 
        }
        .money-display {
            font-size: 42px;
            font-weight: bold;
        }

        .hero-actions {
            display: flex;
            gap: 12px;
        }
        .hero-btn {
            flex: 1;
            background-color: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 0;
            border-radius: 24px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            backdrop-filter: blur(4px);
            transition: background-color 0.2s;
        }
        .hero-btn:active {
            background-color: rgba(255, 255, 255, 0.3);
        }

        /* 列表区域 */
        .list-title {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 12px;
            padding-left: 4px;
        }
        .list-container {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
            min-height: 100px;
        }
        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid #F0F0F0;
            text-decoration: none; 
            color: inherit;
        }
        .item-left {
            display: flex; 
            align-items: center; 
            flex: 1;
        }
        .item-icon {
            width: 40px;
            height: 40px;
            background-color: #EADDFF;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 12px;
            color: #673AB7;
            flex-shrink: 0;
        }
        .item-name {
            font-weight: 500;
            font-size: 16px;
            margin-bottom: 4px;
        }
        .item-date-info {
            font-size: 12px; 
            color: #79747E; 
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .item-right {
            text-align: right;
            margin-left: 12px;
            min-width: 100px;
        }
        .money-text {
            color: #673AB7;
            font-weight: 600;
            font-size: 14px;
        }
        .status-text {
            font-size: 12px; 
            color: #79747E;
            margin-top: 4px;
        }
        .list-item:last-child {
            border-bottom: none;
        }

        .loading-tips {
            padding: 20px;
            text-align: center;
            color: #999;
            font-size: 14px;
        }
    </style>
</head>
<body>

    <div class="hero-card">
        <div class="user-info">
            <div class="avatar" id="userAvatar">...</div>
            <div>
                <div style="font-size: 18px; font-weight: 500;" id="userName">加载中...</div>
                <div style="font-size: 14px; opacity: 0.8;" id="userPhone">...</div>
            </div>
        </div>
        
        <div class="money-container">
            <div style="font-size: 14px; opacity: 0.8; margin-bottom: 4px;">累计已赚权益金 (⭐)</div>
            <div class="money-display" id="userTotalMoney">0.00</div>
        </div>

        <div class="hero-actions">
            <button class="hero-btn" onclick="goToDetail()">权益金明细</button>
            <button class="hero-btn" onclick="alert('提现功能开发中...')">提现 / 转换</button>
        </div>
    </div>

    <div class="list-title">邀请名单</div>
    
    <div class="list-container" id="listContainer">
        <div class="loading-tips">正在获取数据...</div>
    </div>

    <script>
                // === 鉴权守卫 ===
        const TOKEN = localStorage.getItem('auth_token');
        const MY_PHONE = localStorage.getItem('user_phone'); // 登录时的手机号

        if (!TOKEN || !MY_PHONE) {
            window.location.href = 'login.html'; // 没登录，踢走
        }
        // ================

        // 使用登录的手机号，不再硬编码
        const CURRENT_PHONE = MY_PHONE;

        window.onload = function() {
            fetchData();
        }

        function goToDetail() {
            window.location.href = `fund-details.html?phone=${CURRENT_PHONE}`;
        }

        async function fetchData() {
            try {
                // 修改 fetch 的部分
                const res = await fetch(`/api/user-info?phone=${CURRENT_PHONE}`, {
                    headers: {
                        'Authorization': `Bearer ${TOKEN}` // 【关键】带上 Token
                    }
                });
                const json = await res.json();
                console.log('前端收到数据:', json);

                let records = [];
                if (json.data && json.data.result && json.data.result.data) {
                    records = json.data.result.data;
                }

                renderPage(records);

            } catch (error) {
                console.error(error);
                document.getElementById('listContainer').innerHTML = '<div class="loading-tips">加载失败，请检查网络</div>';
            }
        }

        function renderPage(list) {
            const container = document.getElementById('listContainer');
            
            if (!list || list.length === 0) {
                container.innerHTML = '<div class="loading-tips">暂无邀请记录</div>';
                document.getElementById('userName').innerText = '用户';
                document.getElementById('userPhone').innerText = CURRENT_PHONE;
                return;
            }

            // 提取第一条记录的“邀请人信息”来显示顶部卡片
            const firstItemFields = list[0].fields;
            const inviterName = (firstItemFields['邀请人姓名'] && firstItemFields['邀请人姓名'][0]) || '未知用户';
            const inviterPhone = (firstItemFields['邀请人电话'] && firstItemFields['邀请人电话'][0]) || CURRENT_PHONE;

            document.getElementById('userName').innerText = inviterName;
            document.getElementById('userAvatar').innerText = inviterName.charAt(0);
            document.getElementById('userPhone').innerText = inviterPhone;

            let html = '';
            let totalMoney = 0;

            list.forEach(item => {
                const f = item.fields;
                
                // 1. 获取显示信息
                const name = (f['被邀请人姓名'] && f['被邀请人姓名'][0]) || '未知';
                const dateRaw = f['被邀请日'] || ''; 
                const date = dateRaw.split(' ')[0]; 
                const daysLeft = Math.floor(f['邀请期剩余日'] || 0);
                const reward = f['累计奖励'] || 0;
                
                // 2. 【核心修改】获取被邀请人的手机号
                // 因为是引用字段，所以是数组，取第一个⭐素 [0]
                const inviteePhone = (f['被邀请人电话'] && f['被邀请人电话'][0]) || '';

                totalMoney += reward;

                // 3. 【核心修改】链接只传 phone=被邀请人手机号
                html += `
                <a href="detail.html?phone=${inviteePhone}" class="list-item">
                    <div class="item-left">
                        <div class="item-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20" fill="currentColor"><path d="M480-480q-66 0-113-47t-47-113q0-66 47-113t113-47q66 0 113 47t47 113q0 66-47 113t-113 47ZM160-120v-32q0-34 17.5-62.5T224-258q65-32 130-47t126-15q62 0 126.5 15.5T736-258q30 22 47 50.5T800-152v32H160Z"/></svg>
                        </div>
                        <div>
                            <div class="item-name">${name}</div>
                            <div class="item-date-info">
                                <span>邀请日：${date}</span>
                                <span>剩余日期：${daysLeft}天</span>
                            </div>
                        </div>
                    </div>
                    <div class="item-right">
                        <div class="money-text">累计奖励：${Number(reward).toFixed(2)}⭐</div>
              
                    </div>
                </a>
                `;
            });

            container.innerHTML = html;
            document.getElementById('userTotalMoney').innerText = '⭐ ' + totalMoney.toFixed(2);
        }
    </script>
</body>
</html>